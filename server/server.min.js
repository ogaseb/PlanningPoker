!function(e){var o={};function r(t){if(o[t])return o[t].exports;var s=o[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=o,r.d=function(e,o,t){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var s in e)r.d(t,s,function(o){return e[o]}.bind(null,s));return t},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=12)}([function(e,o){e.exports=require("lodash/findIndex")},function(e,o){e.exports=require("pg/lib")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("bcrypt")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("date-and-time")},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("socket.io")},function(e,o){e.exports=require("uuid/v4")},function(e,o){e.exports=require("jira-connector")},function(e,o){e.exports=require("rollbar")},function(e,o,r){"use strict";r.r(o);var t=r(4),s=r.n(t),n=r(6),i=r.n(n),a=r(7),c=r.n(a),m=r(8),u=r.n(m),l=r(0),d=r.n(l),g=r(2),f=r.n(g),p=r(5),h=r.n(p),y=r(3),b=r.n(y),I=(r(11),r(1));var w=r(9),U=r.n(w);var S=r(10),R=r.n(S);let A;function v(){if(A)return A.board.getIssuesForBoard({boardId:boardId})}const k=process.env.PORT||5e3,D=s()(),E=i.a.createServer(D),_=u()(E,{cookie:!1});let T=[],j=new Map,N=new Map,x=new Map;(async function(){const e=new I.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await e.connect();try{const o=await e.query("SELECT * FROM rooms");return e.end(),o}catch(e){console.log(e)}})().then(e=>{e.rows.map(({roomname:e,roomid:o,roompassword:r,timestamp:t,roomhistory:s,roomboardid:n})=>{const i={roomName:"",roomId:"",timestamp:"",boardId:"",user:[],game:[],gameHistory:[]};i.roomName=e,i.roomId=o,i.timestamp=t,i.gameHistory=s,n&&(i.boardId=n),x.set(o,r),N.set(o,i)}),console.log("DB -> fetching rooms from DB")}),_.on("connection",e=>{console.log("User -> connected to server id:",e.id),e.on("jiraLogin",o=>{(function({jiraLogin:e,jiraPassword:o,jiraSubdomain:r}){if(A=new R.a({host:`${r}.atlassian.net`,basic_auth:{username:e,password:o}}))return A.board.getAllBoards({startAt:0})})(o).then(o=>{e.emit("jiraLogin",o)}).catch(o=>{e.emit("errors",{error:o})})}),e.on("jiraGetBoard",o=>{(function(e){if(A)return A.board.getIssuesForBacklog({boardId:e})})(o).then(o=>{if(o.issues.length>0){let r=[];for(let e=0;e<o.issues.length;e++)r.push({id:o.issues[e].id,key:o.issues[e].key,summary:o.issues[e].fields.summary,description:o.issues[e].fields.description,comments:o.issues[e].fields.comment.comments,priorityType:o.issues[e].fields.priority.name,priorityUrl:o.issues[e].fields.priority.iconUrl,issueUrl:o.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBacklogBoard",r),console.log("Jira -> fetching singe board")}}).catch(o=>{e.emit("errors",{error:o})}),v().then(o=>{if(o.issues.length>0){let r=[];for(let e=0;e<o.issues.length;e++)r.push({id:o.issues[e].id,key:o.issues[e].key,summary:o.issues[e].fields.summary,description:o.issues[e].fields.description,comments:o.issues[e].fields.comment.comments,priorityType:o.issues[e].fields.priority.name,priorityUrl:o.issues[e].fields.priority.iconUrl,issueUrl:o.issues[e].fields.issuetype.iconUrl});e.emit("jiraGetBoard",r),console.log("Jira -> fetching singe board")}}).catch(o=>{e.emit("errors",{error:o})})}),e.on("createRoom",({userName:o,roomName:r,roomPassword:t})=>{const s={roomName:"",roomId:"",timestamp:"",boardId:"",user:[],game:[],gameHistory:[]},n=U()();let i=new Date;i=h.a.format(i,"YYYY/MM/DD HH:mm:ss"),s.user.push({userId:e.id,userName:o}),s.roomName=r,s.roomId=n,s.timestamp=i,b.a.hash(t,10,(o,t)=>{x.set(n,t),async function(e,o,r,t){const s=new I.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await s.connect(),await s.query(`INSERT INTO rooms(roomName,roomPassword,roomId,timeStamp) VALUES('${e}', '${o}', '${r}', '${t}')`,(e,o)=>{console.log(e,o),console.log("DB -> save room"),s.end()})}(r,t,n,i),o&&e.emit("errors",{error:o})}),N.set(n,s),j.set(e.id,n),T.push(s),e.join(n),e.emit("createRoom",s),_.in(n).emit("waitingFor",s.game.length),_.in(n).emit("fetchRoomUsers",s.user),console.log("User -> Created room! RoomId:",n)}),e.on("saveBoardId",({roomId:e,boardId:o})=>{!async function(e,o){const r=new I.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await r.connect(),await r.query(`UPDATE rooms SET roomboardid = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room boardId"),r.end()})}(e,o),console.log("User -> Created room! RoomId:",e)}),e.on("joinRoom",({roomId:o,roomPassword:r,userName:t})=>{if(N.has(o)){let s=N.get(o);console.log(s);const n=x.get(o);b.a.compare(r,n,function(r,n){if(n){let r=new Date;r=h.a.format(r,"YYYY/MM/DD HH:mm:ss"),s.timestamp=r,async function(e,o){const r=new I.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await r.connect(),await r.query(`UPDATE rooms SET timestamp = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room timestamp"),r.end()})}(o,r),s.user.push({userId:e.id,userName:t}),j.set(e.id,o),e.join(o);let n=d()(s,function(e){return e.roomId===o});-1!==n&&T[n].user.push({userId:e.id,userName:t}),console.log("User -> Joinsed room! RoomId:",o),e.emit("joinRoom",s),N.set(o,s),_.in(o).emit("waitingFor",s.game.length),_.in(o).emit("fetchRoomUsers",s.user),1===s.user.length&&_.in(o).emit("changeAdmin",s.user[0].userId),console.log(s)}else e.emit("errors",{error:"Invalid Password"})})}else e.emit("errors",{error:"Room not found"})}),e.on("deleteRoom",({roomId:o,roomPassword:r})=>{if(x.has(o)){const t=x.get(o);b.a.compare(r,t,function(r,t){if(t){let r=d()(T,function(e){return e.roomId===o});T.splice(r,1),N.delete(o),async function(e){const o=new I.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await o.connect(),await o.query(`DELETE FROM rooms WHERE roomId = '${e}'`,(e,r)=>{console.log(e,r),console.log("DB -> delete room"),o.end()})}(o),e.emit("deleteRoom"),console.log("User -> Deleted room! RoomId:",o)}else e.emit("errors",{error:"Invalid Password (delete)"})})}}),e.on("sendCard",({roomId:e,userId:o,userName:r,cardValue:t})=>{if(N.has(e)){let s=N.get(e);s.game.push({userName:r,cardValue:t}),console.log(e,o,t);let n=d()(s.user,function(e){return e.userId===o});-1!==n&&(s.user[n].userName=`${s.user[n].userName} - âœ”`,_.in(e).emit("fetchRoomUsers",s.user)),s.user.length===s.game.length?(_.in(e).emit("sendCard",s.game),_.in(e).emit("waitingFor",s.game.length)):_.in(e).emit("waitingFor",s.game.length),N.set(e,s)}}),e.on("resetCards",({roomId:e})=>{if(N.has(e)){let o=N.get(e);for(let e=0;e<o.user.length;e++){let r=o.user[e].userName.split(" - ");o.user[e].userName=r[0]}o.gameHistory.push(o.game),_.in(e).emit("resetCards",o.gameHistory),_.in(e).emit("fetchRoomUsers",o.user),!async function(e,o){const r=new I.Client({connectionString:process.env.DATABASE_URL||"postgres://sebastianogarek:@localhost:5432/sebastianogarek"});await r.connect(),await r.query(`UPDATE rooms SET roomhistory = '${o}' WHERE roomId = '${e}'`,(e,o)=>{console.log(e,o),console.log("DB -> update room history"),r.end()})}(e,JSON.stringify(o.gameHistory)),o.game=[],o.title="",o.description="",_.in(e).emit("waitingFor",o.game.length),N.set(e,o)}}),e.on("fetchRoomUsers",({roomId:e})=>{if(N.has(e)){const o=N.get(e);_.in(e).emit("fetchRoomUsers",o.user),1===o.user.length&&_.in(e.toString()).emit("changeAdmin",o.user[0].userId)}}),e.on("kickUser",({userId:o,userLeaved:r})=>{if(j.has(o)){let e=j.get(o),t=N.get(e.toString()),s=d()(t.user,function(e){return e.userId===o});-1!==s&&(r||_.in(e).emit("kickUser",t.user[s]),t.user.splice(s,1),_.in(e).emit("waitingFor",t.game.length),_.in(e).emit("fetchRoomUsers",t.user),1===t.user.length&&_.in(e).emit("changeAdmin",t.user[0].userId),N.set(e,t),console.log("User -> kicked"))}else e.emit("errors",{error:"Cant find user you trying to kick"})}),e.on("changeAdmin",({userId:o})=>{if(j.has(o)){let e=j.get(o),r=N.get(e.toString()),t=d()(r.user,function(e){return e.userId===o});-1!==t&&(_.in(e.toString()).emit("changeAdmin",r.user[t].userId),console.log("User -> admin permissions given"))}else e.emit("errors",{error:"Cant find user you trying to give admin"})}),e.on("broadcastTitle",({roomId:o,title:r})=>{if(N.has(o)){let t=N.get(o);t.title!==r&&(t.title=r,e.broadcast.to(o).emit("broadcastTitle",r),N.set(o,t))}}),e.on("broadcastDescription",({roomId:o,description:r})=>{if(N.has(o)){let t=N.get(o);t.description!==r&&(t.description=r,e.broadcast.to(o).emit("broadcastDescription",r),N.set(o,t))}}),e.on("disconnect",()=>{if(j.has(e.id)){let o=j.get(e.id);if(N.has(o.toString())){let r=N.get(o.toString()),t=d()(r.user,function(o){return o.userId===e.id});-1!==t&&(r.user.splice(t,1),_.in(o.toString()).emit("waitingFor",r.game.length),1===r.user.length&&_.in(o.toString()).emit("changeAdmin",r.user[0].userId),N.set(o.toString(),r),console.log("User -> disconnected from room"))}}console.log("User -> disconnected from server")}),e.on("disconnecting",e=>{console.log("User -> disconnecting reason:",e)}),e.on("reconnecting",e=>{console.log("User -> lost connection in process of reconnection reason:",e)}),e.on("reconnect",()=>{console.log("User -> user reconnected")})}),D.use(s.a.static(f.a.join(__dirname,"client/build"))),D.get("/room/*/:uuid",function(e,o,r){const{uuid:t}=e.params;if(console.log("Room not found!: ",t),N.has(t))r();else{const e=c.a.readFileSync(f.a.join(__dirname,"client/build/index.html"),"utf-8").replace("</body>","\n      <script>\n        window.__ROOM_NOT_FOUND__ = true\n      <\/script>\n    </body>");o.status(404).send(e)}}),D.get("*",function(e,o){o.sendFile("index.html",{root:f.a.join(__dirname,"client/build")})}),E.listen(k,()=>console.log(`Listening on port ${k}`))}]);